<?php
/**
 * ExploiterID Newsletter
 *
 * @author Fray117
 * @package ExploiterID
 */

function validateAddr($address) {
	if (strtolower($address) === 'unknown') {
		return false;
	}

	// Generate IPv4 Network Address
	$address = ip2long($address);

	// if the IP is set and not equivalent to 255.255.255.255
	if ($address !== false && $address !== -1) {
		// make sure to get unsigned long representation of IP
		// due to discrepancies between 32 and 64 bit OSes and
		// signed numbers (ints default to signed in PHP)
		$address = sprintf('%u', $address);
		// do private network range checking
		if ($address >= 0 && $address <= 50331647) return false;
		if ($address >= 167772160 && $address <= 184549375) return false;
		if ($address >= 2130706432 && $address <= 2147483647) return false;
		if ($address >= 2851995648 && $address <= 2852061183) return false;
		if ($address >= 2886729728 && $address <= 2887778303) return false;
		if ($address >= 3221225984 && $address <= 3221226239) return false;
		if ($address >= 3232235520 && $address <= 3232301055) return false;
		if ($address >= 4294967040) return false;
	}

	return true;
}

function getAddr() {
	// Shared Address
	if (!empty($_SERVER['HTTP_CLIENT_IP']) && validateAddr($_SERVER['HTTP_CLIENT_IP'])) {
		return $_SERVER['HTTP_CLIENT_IP'];
	}

	// Proxied Address
	if (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
		if (strpos($_SERVER['HTTP_X_FORWARDED_FOR'], ',') !== false) {
			$iplist = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);
			foreach ($iplist as $ip) {
				if (validateAddr($ip)) {
					return $ip;
				}
			}
		} elseif (validateAddr($_SERVER['HTTP_X_FORWARDED_FOR'])) {
			return $_SERVER['HTTP_X_FORWARDED_FOR'];
		}
	}
	
	if (!empty($_SERVER['HTTP_X_FORWARDED']) && validateAddr($_SERVER['HTTP_X_FORWARDED'])) {
		return $_SERVER['HTTP_X_FORWARDED'];
	}

	if (!empty($_SERVER['HTTP_X_CLUSTER_CLIENT_IP']) && validateAddr($_SERVER['HTTP_X_CLUSTER_CLIENT_IP'])) {
		return $_SERVER['HTTP_X_CLUSTER_CLIENT_IP'];
	}

	if (!empty($_SERVER['HTTP_FORWARDED_FOR']) && validateAddr($_SERVER['HTTP_FORWARDED_FOR'])) {
		return $_SERVER['HTTP_FORWARDED_FOR'];
	}
	if (!empty($_SERVER['HTTP_FORWARDED']) && validateAddr($_SERVER['HTTP_FORWARDED'])) {
		return $_SERVER['HTTP_FORWARDED'];
	}

	// Unknown Address
	return $_SERVER['REMOTE_ADDR'];
}

$mysqli = new mysqli('localhost', 'tsuroyac_exploit', 'l5SfH7Hl07zpjs8K', 'tsuroyac_xpl0173r');
if ($mysqli->connect_errno) {
	echo "Failed to connect to MySQL: " . $mysqli->connect_error;
}

if (isset($_POST['email'])) {
	if (!empty($_POST['email'])) {
		$mail = trim(addslashes($_POST['email']));
		$addr = getAddr();
		$query = "INSERT INTO `waitlist` (`email`, `address`) VALUES ('" . $mail . "', '" . $addr . "')";
		$row = $mysqli->query("SELECT `id` FROM `waitlist` WHERE `email` = '" . $mail . "'")->fetch_assoc();

		$headers = "MIME-Version: 1.0" . "\r\n";
		$headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
		$headers .= 'From: Subcriber Notifier <notifcations@exploiter.id>' . "\r\n";

		print '<meta http-equiv="refresh" content="3;URL=\'https://exploiter.id/\'" />';
		print '<h1 style="text-align: center;font-family: monospace;font-size: 10em;font-weight: 100;">';

		if (empty($row)) {
			if (preg_match('/^[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$/', $mail)) {
				$mysqli->query($query);
				print 'Subscribed';
				mail('fray117@reset.ga', 'New Subscriber on Waitlist', $mail . ' from ' . $addr, $headers);
			}
		} else {
			print 'Email Already Subscribed';
		}

		print '</h1>';
	} else {
		print '<meta http-equiv="refresh" content="0;URL=\'https://exploiter.id/\'" />';
	}
} else {
	print '<meta http-equiv="refresh" content="0;URL=\'https://exploiter.id/\'" />';
}